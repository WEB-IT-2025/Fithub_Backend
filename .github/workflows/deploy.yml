name: 🚀 EC2へデプロイ & Discord通知

on:
    push:
        branches: [main, dev]
    pull_request:
        branches: [main, dev]

jobs:
    deploy:
        name: 🔄 EC2にデプロイ
        runs-on: ubuntu-latest

        steps:
            - name: 📥 リポジトリをチェックアウト
              uses: actions/checkout@v3

            - name: 🔐 SSHのセットアップ
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.EC2_KEY }}

            - name: 📨 .envファイルをEC2に送信
              run: |
                  echo "${{ secrets.ENV_FILE }}" > .env
                  scp -o StrictHostKeyChecking=no .env ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/fithub/.env

            - name: 🚀 EC2経由でデプロイ実行
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                    BRANCH=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')

                    echo "📁 fithub ディレクトリを準備中..."
                    if [ ! -d "~/fithub/.git" ]; then
                      echo "🆕 リポジトリが存在しないため、cloneを実行します"
                      git clone https://github.com/${{ github.repository }} ~/fithub
                    else
                      echo "📥 既存のリポジトリを更新中（pull）..."
                      cd ~/fithub
                      git pull origin $BRANCH
                    fi

                    echo "📂 fithub ディレクトリに移動中..."
                    cd ~/fithub

                    echo "📦 依存関係のインストール中..."
                    npm install

                    echo "🔨 TypeScriptをビルド中..."
                    npm run build

                    echo "🚀 PM2でアプリを再起動中..."
                    pm2 restart fithub-api || pm2 start dist/index.js --name "fithub-api"

                    echo "💾 状態を保存 (reboot対策)..."
                    pm2 save
                  EOF

    notify-success:
        needs: deploy
        if: success()
        runs-on: ubuntu-latest
        steps:
            - name: ✅ Discord通知（成功）
              run: |
                  curl -X POST -H "Content-Type: application/json" \
                  -d '{
                    "content": "**✅ デプロイが正常に完了しました！**\n📦 リポジトリ: ${{ github.repository }}\n🌿 ブランチ: ${{ github.ref_name }}\n👤 実行者: ${{ github.actor }}"
                  }' ${{ secrets.DISCORD_WEBHOOK_URL }}

    notify-failure:
        needs: deploy
        if: failure()
        runs-on: ubuntu-latest
        steps:
            - name: ❌ Discord通知（失敗）
              run: |
                  curl -X POST -H "Content-Type: application/json" \
                  -d '{
                    "content": "**❌ デプロイに失敗しました！**\n📦 リポジトリ: ${{ github.repository }}\n🌿 ブランチ: ${{ github.ref_name }}\n👤 実行者: ${{ github.actor }}"
                  }' ${{ secrets.DISCORD_WEBHOOK_URL }}
