name: ğŸš€ EC2ã¸ãƒ‡ãƒ—ãƒ­ã‚¤ & Discordé€šçŸ¥

on:
    push:
        branches: [main, dev]
    pull_request:
        branches: [main, dev]

jobs:
    deploy:
        name: ğŸ”„ EC2ã«ãƒ‡ãƒ—ãƒ­ã‚¤
        runs-on: ubuntu-latest

        steps:
            # â‘  ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
            - name: ğŸ“¥ ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
              uses: actions/checkout@v3

            # â‘¡ SSH Agentã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆç§˜å¯†éµï¼‰
            - name: ğŸ” SSHã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
              uses: webfactory/ssh-agent@v0.7.0
              with:
                  ssh-private-key: ${{ secrets.EC2_KEY }}

            # â‘¢ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’EC2ã«é€ä¿¡
            - name: ğŸ“¨ .envãƒ•ã‚¡ã‚¤ãƒ«ã‚’EC2ã«é€ä¿¡
              run: |
                  echo "${{ secrets.ENV_FILE }}" > .env
                  ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'mkdir -p ~/fithub'
                  scp -o StrictHostKeyChecking=no .env ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/fithub/.env

            # â‘£ ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
            - name: ğŸš€ EC2çµŒç”±ã§ãƒ‡ãƒ—ãƒ­ã‚¤å®Ÿè¡Œ
              run: |
                  ssh -o StrictHostKeyChecking=no ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
                    BRANCH=$(echo "${{ github.ref }}" | sed 's|refs/heads/||')

                    echo "ğŸ“ fithub ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æº–å‚™ä¸­..."
                    if [ ! -d "$HOME/fithub/.git" ]; then
                      echo "âš ï¸ .gitãŒå­˜åœ¨ã—ãªã„ â†’ ãƒ•ã‚©ãƒ«ãƒ€ã‚’å‰Šé™¤ã—ã¦cloneã—ç›´ã—ã¾ã™"
                      rm -rf $HOME/fithub
                      git clone https://github.com/${{ github.repository }} $HOME/fithub
                    else
                      echo "ğŸ“¥ æ—¢å­˜ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’æ›´æ–°ä¸­ï¼ˆgit pullï¼‰..."
                      cd $HOME/fithub
                      git reset --hard
                      git clean -fd
                      git pull origin $BRANCH
                    fi

                    echo "ğŸ“‚ fithub ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•ä¸­..."
                    cd $HOME/fithub

                    echo "ğŸ“¦ ä¾å­˜é–¢ä¿‚ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
                    npm install

                    echo "ğŸ”¨ TypeScriptã‚’ãƒ“ãƒ«ãƒ‰ä¸­..."
                    npm run build

                    echo "ğŸš€ PM2ã§ã‚¢ãƒ—ãƒªã‚’å†èµ·å‹•ä¸­..."
                    pm2 restart fithub-api || pm2 start dist/index.js --name "fithub-api"

                    echo "ğŸ’¾ PM2 çŠ¶æ…‹ã‚’ä¿å­˜ï¼ˆrebootå¯¾ç­–ï¼‰..."
                    pm2 save
                  EOF

    # â‘¤ ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸæ™‚ã®é€šçŸ¥
    notify-success:
        needs: deploy
        if: success()
        runs-on: ubuntu-latest
        steps:
            - name: âœ… Discordé€šçŸ¥ï¼ˆæˆåŠŸï¼‰
              run: |
                  curl -X POST -H "Content-Type: application/json" \
                  -d '{
                    "content": "**âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼**\nğŸ“¦ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}\nğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\nğŸ‘¤ å®Ÿè¡Œè€…: ${{ github.actor }}"
                  }' ${{ secrets.DISCORD_WEBHOOK_URL }}

    # â‘¥ ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—æ™‚ã®é€šçŸ¥
    notify-failure:
        needs: deploy
        if: failure()
        runs-on: ubuntu-latest
        steps:
            - name: âŒ Discordé€šçŸ¥ï¼ˆå¤±æ•—ï¼‰
              run: |
                  curl -X POST -H "Content-Type: application/json" \
                  -d '{
                    "content": "**âŒ ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¤±æ•—ã—ã¾ã—ãŸï¼**\nğŸ“¦ ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.repository }}\nğŸŒ¿ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\nğŸ‘¤ å®Ÿè¡Œè€…: ${{ github.actor }}"
                  }' ${{ secrets.DISCORD_WEBHOOK_URL }}
